name: Version Bump

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version (semver format: X.Y.Z)'
        required: true
        type: string
      version_description:
        description: 'Version description (e.g., "Stable Release", "Bug Fix")'
        required: false
        default: ''
        type: string
      create_tag:
        description: 'Create git tag (triggers release workflow)'
        required: true
        default: false
        type: boolean

jobs:
  version-bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ Error: Version must be in semver format (X.Y.Z)"
            echo "   Provided: $VERSION"
            exit 1
          fi
          echo "âœ… Version format valid: $VERSION"

      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if tag already exists
        run: |
          VERSION="${{ inputs.version }}"
          if git tag -l "v$VERSION" | grep -q "v$VERSION"; then
            echo "âŒ Error: Tag v$VERSION already exists"
            exit 1
          fi
          echo "âœ… Tag v$VERSION does not exist"

      - name: Delete existing draft releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Checking for draft releases..."
          DRAFTS=$(gh release list --json tagName,isDraft --jq '.[] | select(.isDraft) | .tagName')
          if [ -z "$DRAFTS" ]; then
            echo "âœ… No draft releases found"
          else
            echo "$DRAFTS" | while read -r tag; do
              echo "ğŸ—‘ï¸  Deleting draft release: $tag"
              gh release delete "$tag" --yes
            done
            echo "âœ… Draft releases cleaned up"
          fi

      - name: Get current version
        id: current
        run: |
          CURRENT=$(grep -oP '^version = "\K[^"]+' Cargo.toml)
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Current version: $CURRENT"

      - name: Update Cargo.toml
        run: |
          VERSION="${{ inputs.version }}"
          sed -i "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" Cargo.toml
          echo "âœ… Updated Cargo.toml"
          grep "^version" Cargo.toml

      - name: Update tauri.conf.json
        run: |
          VERSION="${{ inputs.version }}"
          jq --arg v "$VERSION" '.version = $v' tauri.conf.json > tauri.conf.json.tmp
          mv tauri.conf.json.tmp tauri.conf.json
          echo "âœ… Updated tauri.conf.json"
          jq '.version' tauri.conf.json

      - name: Update package.json
        run: |
          VERSION="${{ inputs.version }}"
          jq --arg v "$VERSION" '.version = $v' package.json > package.json.tmp
          mv package.json.tmp package.json
          echo "âœ… Updated package.json"
          jq '.version' package.json

      - name: Update README.md
        run: |
          VERSION="${{ inputs.version }}"
          OLD_VERSION="${{ steps.current.outputs.version }}"

          # Update version badge
          sed -i "s/Version-[0-9]*\.[0-9]*\.[0-9]*-blue/Version-$VERSION-blue/g" README.md

          # Update release tag URLs
          sed -i "s|/releases/tag/v[0-9]*\.[0-9]*\.[0-9]*|/releases/tag/v$VERSION|g" README.md

          # Update inline version references (v1.0.1) format
          sed -i "s/(v$OLD_VERSION)/(v$VERSION)/g" README.md

          # Update version references without parentheses
          sed -i "s/v$OLD_VERSION Stable/v$VERSION Stable/g" README.md

          echo "âœ… Updated README.md"
          echo "ğŸ“‹ Version references found:"
          grep -n "$VERSION" README.md | head -10

      - name: Update ESSENTIAL.md
        run: |
          VERSION="${{ inputs.version }}"
          sed -i "s/^\*\*Version\*\*: v[0-9]*\.[0-9]*\.[0-9]*/\*\*Version\*\*: v$VERSION/" .ai-context/ESSENTIAL.md
          echo "âœ… Updated ESSENTIAL.md"
          grep "Version" .ai-context/ESSENTIAL.md | head -1

      - name: Verify all versions match
        run: |
          VERSION="${{ inputs.version }}"

          echo "ğŸ” Verifying version consistency..."

          # Check Cargo.toml
          CARGO_VER=$(grep -oP '^version = "\K[^"]+' Cargo.toml)
          if [ "$CARGO_VER" != "$VERSION" ]; then
            echo "âŒ Cargo.toml version mismatch: $CARGO_VER"
            exit 1
          fi

          # Check tauri.conf.json
          TAURI_VER=$(jq -r '.version' tauri.conf.json)
          if [ "$TAURI_VER" != "$VERSION" ]; then
            echo "âŒ tauri.conf.json version mismatch: $TAURI_VER"
            exit 1
          fi

          # Check package.json
          PKG_VER=$(jq -r '.version' package.json)
          if [ "$PKG_VER" != "$VERSION" ]; then
            echo "âŒ package.json version mismatch: $PKG_VER"
            exit 1
          fi

          echo "âœ… All version files match: $VERSION"
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "   Cargo.toml:      $CARGO_VER"
          echo "   tauri.conf.json: $TAURI_VER"
          echo "   package.json:    $PKG_VER"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version bump
        run: |
          VERSION="${{ inputs.version }}"
          DESCRIPTION="${{ inputs.version_description }}"

          git add Cargo.toml tauri.conf.json package.json README.md .ai-context/ESSENTIAL.md

          # Build commit message
          if [ -n "$DESCRIPTION" ]; then
            COMMIT_MSG="chore(release): bump version to v$VERSION - $DESCRIPTION [skip ci]"
          else
            COMMIT_MSG="chore(release): bump version to v$VERSION [skip ci]"
          fi

          git commit -m "$COMMIT_MSG"
          echo "âœ… Created commit: $COMMIT_MSG"

      - name: Push to dev
        run: |
          git push origin dev
          echo "âœ… Pushed to dev branch"

      - name: Create and push tag
        if: ${{ inputs.create_tag }}
        run: |
          VERSION="${{ inputs.version }}"
          DESCRIPTION="${{ inputs.version_description }}"

          # Build tag message
          if [ -n "$DESCRIPTION" ]; then
            TAG_MSG="v$VERSION - $DESCRIPTION"
          else
            TAG_MSG="v$VERSION"
          fi

          git tag -a "v$VERSION" -m "$TAG_MSG"
          git push origin "v$VERSION"
          echo "âœ… Created and pushed tag: v$VERSION"
          echo ""
          echo "ğŸš€ Release workflow will be triggered automatically"

      - name: Summary
        run: |
          VERSION="${{ inputs.version }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Version Bump Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  ğŸ“¦ New version: v$VERSION"
          echo "  ğŸ“ Description: ${{ inputs.version_description || 'N/A' }}"
          echo ""
          echo "  Updated files:"
          echo "    âœ… Cargo.toml"
          echo "    âœ… tauri.conf.json"
          echo "    âœ… package.json"
          echo "    âœ… README.md"
          echo "    âœ… .ai-context/ESSENTIAL.md"
          echo ""
          if [ "${{ inputs.create_tag }}" = "true" ]; then
            echo "  ğŸ·ï¸  Tag created: v$VERSION"
            echo "  ğŸš€ Release workflow triggered"
          else
            echo "  â„¹ï¸  No tag created (dry run mode)"
            echo "  ğŸ’¡ Run again with create_tag=true to trigger release"
          fi
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
