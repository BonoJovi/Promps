name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes generation

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: get version
        run: echo "PACKAGE_VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: generate release notes
        id: release-notes
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"%s" --no-merges)
          else
            echo "Generating notes from $PREV_TAG to HEAD"
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges)
          fi

          # Initialize sections
          FEAT=""
          FIX=""
          REFACTOR=""
          DOCS=""
          CI=""
          TEST=""
          CHORE=""
          OTHER=""

          # Process each commit
          while IFS= read -r line; do
            # Skip empty lines, [skip ci], and Revert commits
            [ -z "$line" ] && continue
            echo "$line" | grep -qi "\[skip ci\]" && continue
            echo "$line" | grep -qi "^Revert" && continue

            # Extract type and message
            if echo "$line" | grep -qE "^feat(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^feat(\(.*\))?:\s*//')
              FEAT="${FEAT}- ${MSG}\n"
            elif echo "$line" | grep -qE "^fix(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^fix(\(.*\))?:\s*//')
              FIX="${FIX}- ${MSG}\n"
            elif echo "$line" | grep -qE "^refactor(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^refactor(\(.*\))?:\s*//')
              REFACTOR="${REFACTOR}- ${MSG}\n"
            elif echo "$line" | grep -qE "^docs(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^docs(\(.*\))?:\s*//')
              DOCS="${DOCS}- ${MSG}\n"
            elif echo "$line" | grep -qE "^ci(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^ci(\(.*\))?:\s*//')
              CI="${CI}- ${MSG}\n"
            elif echo "$line" | grep -qE "^test(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^test(\(.*\))?:\s*//')
              TEST="${TEST}- ${MSG}\n"
            elif echo "$line" | grep -qE "^chore(\(.*\))?:"; then
              MSG=$(echo "$line" | sed -E 's/^chore(\(.*\))?:\s*//')
              CHORE="${CHORE}- ${MSG}\n"
            else
              OTHER="${OTHER}- ${line}\n"
            fi
          done <<< "$COMMITS"

          # Build release notes
          NOTES="## What's Changed\n\n"

          [ -n "$FEAT" ] && NOTES="${NOTES}### âœ¨ Features\n${FEAT}\n"
          [ -n "$FIX" ] && NOTES="${NOTES}### ðŸ› Bug Fixes\n${FIX}\n"
          [ -n "$REFACTOR" ] && NOTES="${NOTES}### â™»ï¸ Refactoring\n${REFACTOR}\n"
          [ -n "$DOCS" ] && NOTES="${NOTES}### ðŸ“š Documentation\n${DOCS}\n"
          [ -n "$CI" ] && NOTES="${NOTES}### ðŸ”§ CI/CD\n${CI}\n"
          [ -n "$TEST" ] && NOTES="${NOTES}### ðŸ§ª Tests\n${TEST}\n"
          [ -n "$CHORE" ] && NOTES="${NOTES}### ðŸ”¨ Chores\n${CHORE}\n"
          [ -n "$OTHER" ] && NOTES="${NOTES}### ðŸ“ Other\n${OTHER}\n"

          # Add compare link
          if [ -n "$PREV_TAG" ]; then
            NOTES="${NOTES}**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${PACKAGE_VERSION}"
          fi

          # Save to file for multi-line support
          echo -e "$NOTES" > release_notes.md
          cat release_notes.md

      - name: create release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const releaseNotes = fs.readFileSync('release_notes.md', 'utf8');
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${process.env.PACKAGE_VERSION}-free`,
              name: `Promps Free v${process.env.PACKAGE_VERSION}`,
              body: releaseNotes,
              draft: true,
              prerelease: false
            })
            return data.id

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: install frontend dependencies
        run: npm install
        working-directory: ./res/tests

      - name: run backend tests
        run: cargo test

      - name: run frontend tests
        run: npm test
        working-directory: ./res/tests

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

  publish-release:
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    needs: [create-release, build-tauri]

    steps:
      - name: publish release
        id: publish-release
        uses: actions/github-script@v7
        env:
          release_id: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: process.env.release_id,
              draft: false,
              prerelease: false
            })
